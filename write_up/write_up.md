# Anti-Analysis Techniques

## What will be covered in this write up?
- [Process Names](#process-names)
- [Process VersionInfo](#process-versioninfo)
- [Debugger Detection](#debugger-detection)
- [Virtual MAchine Detection](#virtual-machine-detection)

> In this write-up we will be covering some common techniques malware authors often utilize in order to identify if their executable is being analyzed. Malware authors will often use these checks to make their malware act benign or simply do nothing/ self delete.


### Process Names

> We will start off this section with probably the easiest method a malware developer can use to thwart a reverse engineers efforts, looking for the process names of analysis tools. Typically malware authors won't be lazy like myself and just simply look for strings of tool file names i.e: Autoruns64.exe or Procmon64.exe... In this case you are lucky, as this is simply an example you can simply look at the dissassembled code to find the subroutine that conducts this check.

>To set the scene, you are a malware analyst that has just been passed a sample piece of malware that is said to open a powershell console on a users computer.

>With an instance of procmon open, attempt to run the anti_analysis_1.exe and notice that the it should result in the creation of a notepad process. But wait... you were told that this executable was supposed to open up a powershell console on your machine. There must be some anti-analysis going on.
![alt text](https://raw.githubusercontent.com/potato4974/Malware-Anti-Analysis/main/write_up/images/Process%20Names/Create_Notepad.PNG?w=300&h=300)

>After some static analysis, wether with basic tools or a dissassembler you should notice immediately that the binary is packed using upx Version 4.24. Ensure that the file is unpackedq, using either manual or automated techniques covered in the [Malware Unpacking and Identifying PRocess Injection](https://github.com/potato4974/Malware-Unpacking-and-Identifying-Process-Injection) write up. 
<br>![alt text](https://raw.githubusercontent.com/potato4974/Malware-Anti-Analysis/main/write_up/images/Process%20Names/UPX.png)

>Once the binary has been unpacked, you should dissassemble the executable using whichever tool you are most confortable with.(IDA/Ghidra). And at this point simply search for strings related to analysis tools executable names.
![alt text](https://raw.githubusercontent.com/potato4974/Malware-Anti-Analysis/main/write_up/images/Process%20Names/assembly.png)<br>
As per above you can easily find the subroutine doing this name check, (Renamed here to Process_Name_Checker).

>The easiest method to resolve this type of anti_analysis is to simply rename your analysis tools so they don't match any of those checked. In this case I renamed the procmon executable to Not_Procmon as seen below.
![alt text](https://raw.githubusercontent.com/potato4974/Malware-Anti-Analysis/main/write_up/images/Process%20Names/Not_Procmon.png)
<br>This then allowed me to run the "malware" no problem resulting in a powershell console rather than notepad.
![alt text](https://raw.githubusercontent.com/potato4974/Malware-Anti-Analysis/main/write_up/images/Process%20Names/Power_Shell.png)

>And at this point we've easily mitigated the 

<!-- How this works "A Deeper Analysis":

- Pushes the names of common analysis tools onto the stack

- Utilized the [CreateToolhelp32Snapshot](https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot) Windows API call to create a "snapshot" of all of the processes 

The following function was used to create a snapshot of all of the processes currently running on the victim machine. -->

### Process VersionInfo

### Debugger Detection

### Virtual Machine Detection
